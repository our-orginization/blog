title: 移动端页面开发手记（一）
date: 2017-12-25
categories: web mobile
tags:
- mobile
- web

---

###### A pixel is not a pixel is not a pixel.

<!-- more -->
### 一.像素
像素是web页面布局的基础，那么到底什么才是一个像素呢？在PC开发时，我对像素的理解就是简单的1个px。

那么看看百度百科的解释：
像素是指由图像的小方格即所谓的像素(pixel)组成的，这些小方块都有一个明确的位置和被分配的色彩数值，而这些一小方格的颜色和位置就决定该图像所呈现出来的样子。可以将像素视为整个图像中不可分割的单位或者是元素，不可分割的意思是它不能够再切割成更小单位抑或是元素，它是以一个单一颜色的小格存在。每一个点阵图像包含了一定量的像素，这些像素决定图像在屏幕上所呈现的大小。

实际上，在Web开发领域，像素有以下两层含义：
- 设备像素：设备屏幕的物理像素，对于任何设备来讲物理像素的数量是固定的。
######   比如iPhone 5的分辨率640 x 1136px。。
- CSS像素：这是一个抽象的像素概念，它是Web编程的概念，指的是CSS样式代码中使用的逻辑像素。
###### 在CSS规范中，长度单位可以分为两类，绝对(absolute)单位以及相对(relative)单位。px是一个相对单位，相对的是设备像素(device pixel)。

如下图，是在缩放比例为1，即scale = 1的情况下，设备像素和CSS像素示意图:

![image](https://p0.meituan.net/dpnewvc/5feca8ed6f794dbadd5e43e6a2f95c586414.jpg)

那么再深入的考虑这样一个问题，当我给一个元素设置了 width: 200px;这条样式的时候，到底发生了什么事情？

可能有人会说：“废话！元素的宽度是200px呗。”对，并没有什么问题，但是这个200px指的是什么呢？因为我们知道，对于web前端来讲像素有两层含义，那么到底是设备像素还是CSS像素？实际上我们控制的是CSS像素，因为前面提到了，CSS像素是给我们web前端开发者创造的抽象概念。所以你要记住：当你给元素设置了 width: 200px 时，这个元素的宽度跨越了200个CSS像素。但是它并不一定跨越200个设备像素，至于会跨越多少个设备像素，就取决于手机屏幕的特性和用户的缩放了,举个栗子：

苹果手机的Retina视网膜屏幕，是一个高密度屏幕，它的像素密度是普通屏幕的2倍，所以当我们设置 width: 2px; 时，2个CSS像素跨越了4个设备像素如图：

![image](https://p0.meituan.net/dpnewvc/3ddae5377226f4e0682519c3a3333c334368.png)

CSS像素的大小是可变的，比如用后缩放页面的时候，实际上就是在缩小或放大CSS像素，而设备像素无论大小还是数量都是不变的。

### 二.移动端的三个视图
你一定写过这样一条样式： width:25%; 但是你有想过给一个元素加上这样一条样式之后发生了什么吗？25%是基于谁的25%？明白的同学可能知道了：一个块元素默认的宽度是其父元素的100%，是基于起父元素的，所以25%指的是父元素宽度的25%，所以，body元素的默认宽度是html元素宽度的100%，那么你有没有想过html元素的宽度是基于谁的呢？这个时候，就要引出一个概念：**初始包含块**和**视口**。

记住一句话：视口是html的父元素，所以我们称视口为**初始包含块**。 这样你就明白了，**html元素的百分比是基于视口的**。

#### 视图一： 布局视口
###### 布局视口：移动端CSS布局的依据视口，即CSS布局会根据布局视口来计算。
写过css的小伙伴应该知道，我们在 html、 body设置 width:100%;height:100%;的时候，它并不是无效的。我们都知道 100%这种百分数应该是继承父元素而来的。那在这里是继承哪里的呢？
在PC浏览器中，有一个用来约束CSS布局视口的东西，又叫做初始包含块。这也就是所有宽高继承的由来。除去 margin、 padding，布局视口和浏览器可视窗口宽度是一致的，同时也和浏览器本身的宽度一致。
在PC浏览器中，视口只有一个，并且 视口的宽度 = 浏览器窗口的宽度，但是在移动端也要根据这个来设计的话，那么PC端设计的网站在移动端看起来会很丑，因为PC端的网页宽度在800 ~ 1024个CSS像素，而手机屏幕要窄的多，这个时候再PC端25%的宽度在移动端看起来会很窄。所以，布局视口的概念产生了。

也就是说，在移动端，视口和浏览器窗口将不在关联，实际上，布局视口要比浏览器窗口大的多(在手机和平板中浏览器布局视口的宽度在768~1024像素之间)，如下图（布局视口和窗口的关系）：

![image](https://p1.meituan.net/dpnewvc/eb60ec0ff69b0edb5644446a2d21f61d9333.jpg)

可以通过以下JavaScript代码获取布局视口的宽度和高度：
```javascript
document.documentElement.clientWidth
document.documentElement.clientHeight
```
#### 视图二： 视觉视图
![image](https://p0.meituan.net/dpnewvc/e5aeb136d24d570d8a0fe38310b554f131989.png)
对于视觉视口来说，这个东西是呈现给用户的，它是用户看到网页区域内CSS像素的数量。由于用户可以自行进行缩放控制，所以这个视口并不是开发者需要重点关注的。
值得注意的是，在移动端缩放不会改变布局视口的宽度，当缩小的时候，屏幕覆盖的css像素变多，视觉视口变大，反之亦然。
而在PC端，缩放对应布局宽度和视觉窗口宽度都是联动的。而浏览器宽度本身是固定的，无论怎么缩放都不受影响。
如果对上面的宽度还是很乱，那么这里有一个表格可以帮助你理清思路。
以下表格横向都以浏览器窗口的宽度作为基准：
- PC端
状态 | 布局视口 | 视觉视口 | 浏览器窗口（基准）
-----|-----|-----|-----
默认 | 相等 | 相等 | -
放大 | 变小 | 变小 | -
缩小 | 变大 | 变大 | -
- 移动端
状态 | 布局视口 | 视觉视口 | 浏览器窗口（基准）
-----|-----|-----|-----
默认 | 偏大 | 相等 | -
放大 | 不变 | 变小 | -
缩小 | 不变 | 变大 | -


#### 视图三： 理想视图
我们前面提到过，布局视口的宽度一般在 680~1024像素之间，这样可以使得PC网站在手机中不被压扁，但是这并不理想，因为手机更适合窄的网站，换句话说，布局视口并不是最理想的宽度，所以，就引入了理想视口。

理想视口，定义了理想视口的宽度，比如对于iphone5来讲，理想视口是320*568。但是最终作用的还是布局视口，因为我们的css是依据布局视口计算的，所以你可以这样理解理想视口：理想的布局视口。下面这段代码可以告诉手机浏览器要把布局视口设为理想视口：
```html
<meta name="viewport" content="width=device-width" />
```
然而，这段代码其实也并不完美，在IE浏览器中，由于横屏竖屏的切换会对其造成影响，为了解决这个兼容性的问题，最后再加上一句，就有了现在的：
```html
<meta name="viewport" content="width=device-width" initial-scale=1.0/>
```
initial-scale=1 的意思是初始缩放的比例是1，使用它的时候，同时也会将布局视口的尺寸设置为缩放后的尺寸。而缩放的尺寸就是基于屏幕的宽度来的，也就起到了和width=device-width```同样的效果。

总结一下：
- 在PC端，布局视口就是浏览器窗口
- 在移动端，视口被分为两个：布局视口、视觉视口。
- 移动端还有一个理想视口，它是布局视口的理想尺寸，即理想的布局视口。
- 可以将布局视口的宽度设为理想视口

### 三、设备像素比(Device Pixel Ratio 简称：DPR)
有时候我们会发现，当我们在适某一机型的时候，显示上没什么问题。但是一旦我换到另外一部手机，发现出现了模糊的情况，尤其以图片更为显著。
其实这个问题，就是涉及到了上面讲到的一个属性：设备像素比，即我们经常说的dpr。下面先来看dpr的表现：
假设现在有一台iphone6，那么它的设备独立像素是375x667，dpr为2，尺寸是4.7in，那么物理像素就是750x1334。
同样的我们也有一台不知名的设备，它的设备独立像素刚好也是375x667，尺寸也是4.7in，但是dpr为1，此时的物理像素就是375x667。

下面是设备像素比的计算公式（公式成立的大前提：缩放比例为1）：
###### 设备像素比(DPR) = 设备像素个数 / 理想视口CSS像素个数(device-width)
与理想视口一样，设备像素比对于不同的设备是不同的，但是他们都是合理的，比如早起iphone的设备像素是320px，理想视口也是320px，所以早起iphone的DPR=1，而后来iphone的设备像素为640px，理想视口还是320px，所以后来iphone的DPR=2。
而对于缩放来说，**缩小放大的是 CSS像素**。

#### 模糊的产生
知道了1个css像素覆盖的物理像素可能不同，就好理解为什么会出现模糊的情况了。
这里又讲到一个名词：**位图像素**。
位图像素是栅格图像（如：png,jpg,gif等）最小的数据单元。每一个位图像素都包含着一些自身的显示信息。（如：显示位置，颜色值，透明度等）
理论上来说，**1个位图像素对应1个物理像素，图片才能等到完美清晰的展示**。
但是上面说过，在retina屏幕上，会出现1个位图像素对应多个物理像素。
还是以iphone6为例，1个位图像素对应4个物理像素。由于单个位图像素已经是最小的数据单位了，它不能再被进行切割。于是为了能够显示出来，就只能就近取色，从而导致所谓的图片模糊问题。

#### 如何解决
很明显，由于位图像素不够分而产生模糊的情况，解决的办法十分简单，就是使用跟dpr同个倍数大小的图片。比如iphone6，一个200x300的 img标签，原图就要提供400x600的大小。
那么当加载到 img标签中，浏览器会自动对每1px的css像素减半，可以理解为此时还是维持着1:1的css像素:物理像素，不产生模糊。
这个做法其实就是手淘团队在做retina适配的一个重要的原理之一，后面会讲到，这里先放着不说。

### 四.meta标签
meta视口标签存在的主要目的是为了让布局视口和理想视口的宽度匹配，meta视口标签应该放在HTML文档的head标签内，语法如下：
```html  
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
```

其中 content 属性是一个字符串值，字符串是由逗号“，”分隔的 名/值 对组成，共有5个：
- width：设置布局视口的宽
- init-scale：设置页面的初始缩放程度
- minimum-scale：设置了页面最小缩放程度
- maximum-scale：设置了页面最大缩放程度
- user-scalable：是否允许用户对页面进行缩放操作

上面代码的意思是，让布局视口的宽度等于理想视口的宽度，页面的初始缩放比例以及最大缩放比例都为1，且不允许用户对页面进行缩放操作。